name: Build Legacy PHP (7.4)

# PHP 7.4.33 is the final release — this only needs to run once.
# After the first successful run, the php-7.4 release is permanent
# and the weekly mirror workflow includes it in the manifest.

on:
  workflow_dispatch:

permissions:
  contents: write

env:
  PHP_VERSION: "7.4.33"
  PHP_MINOR: "7.4"
  OPENSSL_VERSION: "1.1.1w"

jobs:
  # ---------------------------------------------------------------------------
  # Build PHP 7.4 from source on native runners
  # ---------------------------------------------------------------------------
  build-unix:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            platform: macos-aarch64
          - os: ubuntu-22.04
            platform: linux-x86_64
          - os: ubuntu-22.04-arm
            platform: linux-aarch64
    runs-on: ${{ matrix.os }}
    steps:
      - name: Install build dependencies (macOS)
        if: startsWith(matrix.os, 'macos')
        run: |
          # Only install libs known to be compatible with PHP 7.4.
          # Do NOT install libxml2 (2.13+ breaks PHP 7.4) or icu4c (78+ breaks intl).
          # We build libxml2 2.11 from source below; intl is skipped on macOS.
          brew install autoconf automake bison re2c pkg-config \
            sqlite openssl@1.1 curl zlib libpng libjpeg-turbo \
            oniguruma libzip libsodium

      - name: Build libxml2 2.11 from source (macOS)
        if: startsWith(matrix.os, 'macos')
        run: |
          curl -fSL "https://download.gnome.org/sources/libxml2/2.11/libxml2-2.11.9.tar.xz" -o libxml2.tar.xz
          tar xf libxml2.tar.xz
          cd libxml2-2.11.9
          ./configure --prefix=/opt/libxml2 --without-python --without-lzma
          make -j"$(sysctl -n hw.ncpu)"
          sudo make install
          echo "libxml2 2.11.9 installed to /opt/libxml2"

      - name: Install build dependencies (Linux)
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential autoconf automake bison re2c \
            pkg-config libxml2-dev libsqlite3-dev libcurl4-openssl-dev \
            zlib1g-dev libpng-dev libjpeg-dev libonig-dev libzip-dev libicu-dev \
            libsodium-dev libreadline-dev

      - name: Build OpenSSL 1.1 from source (Linux)
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          curl -fSL "https://github.com/openssl/openssl/releases/download/OpenSSL_1_1_1w/openssl-${OPENSSL_VERSION}.tar.gz" -o openssl.tar.gz
          tar xzf openssl.tar.gz
          cd "openssl-${OPENSSL_VERSION}"
          ./config --prefix=/opt/openssl-1.1 --openssldir=/opt/openssl-1.1 no-shared
          make -j"$(nproc)"
          sudo make install_sw
          echo "OpenSSL 1.1 installed to /opt/openssl-1.1"
          /opt/openssl-1.1/bin/openssl version

      - name: Download PHP source
        run: |
          curl -fSL "https://www.php.net/distributions/php-${PHP_VERSION}.tar.gz" -o php-src.tar.gz
          tar xzf php-src.tar.gz
          mv "php-${PHP_VERSION}" php-src

      - name: Configure PHP
        run: |
          cd php-src

          # PHP 7.4 uses APIs removed/changed in newer OpenSSL/libxml2.
          # Modern Clang (16+) treats incompatible function pointers as errors.
          # Suppress all warnings and demote remaining errors to warnings.
          export CFLAGS="-w -Wno-error -Wno-incompatible-function-pointer-types -Wno-int-conversion"

          CONFIGURE_FLAGS=(
            --disable-debug
            --disable-phpdbg
            --enable-bcmath
            --enable-calendar
            --enable-exif
            --enable-fpm
            --enable-ftp
            --enable-gd
            --enable-mbstring
            --enable-opcache
            --enable-pcntl
            --enable-shmop
            --enable-soap
            --enable-sockets
            --enable-sysvmsg
            --enable-sysvsem
            --enable-sysvshm
            --with-curl
            --with-jpeg
            --with-mysqli=mysqlnd
            --with-pdo-mysql=mysqlnd
            --with-readline
            --with-sodium
            --with-zip
            --with-zlib
          )

          if [[ "${{ matrix.platform }}" == macos-* ]]; then
            # macOS: use our source-built libxml2 2.11, skip intl (ICU 78+ incompatible)
            OPENSSL_DIR="$(brew --prefix openssl@1.1)"
            LIBJPEG_DIR="$(brew --prefix libjpeg-turbo)"
            LIBZIP_DIR="$(brew --prefix libzip)"
            SODIUM_DIR="$(brew --prefix libsodium)"
            READLINE_DIR="$(brew --prefix readline)"
            export PATH="$(brew --prefix bison)/bin:$PATH"

            # DNS resolver functions (res_nsearch etc.) live in libresolv on macOS
            # Use system iconv (not Homebrew's) so the binary is portable
            export EXTRA_LIBS="-lresolv"

            CONFIGURE_FLAGS+=(
              --with-iconv=/usr
              --with-openssl="$OPENSSL_DIR"
              --with-sodium="$SODIUM_DIR"
              --with-readline="$READLINE_DIR"
              --with-libxml-dir=/opt/libxml2
            )
            export PKG_CONFIG_PATH="/opt/libxml2/lib/pkgconfig:${OPENSSL_DIR}/lib/pkgconfig:${LIBZIP_DIR}/lib/pkgconfig:${SODIUM_DIR}/lib/pkgconfig:${LIBJPEG_DIR}/lib/pkgconfig"
          else
            # Linux: enable intl (system ICU is compatible)
            CONFIGURE_FLAGS+=(--enable-intl)
            # Linux: use locally-built OpenSSL 1.1
            CONFIGURE_FLAGS+=(
              --with-openssl=/opt/openssl-1.1
            )
            export PKG_CONFIG_PATH="/opt/openssl-1.1/lib/pkgconfig:$PKG_CONFIG_PATH"
          fi

          echo "Running configure..."
          ./configure "${CONFIGURE_FLAGS[@]}"

      - name: Build PHP
        run: |
          cd php-src
          make -j"$(nproc 2>/dev/null || sysctl -n hw.ncpu)"
          echo "Build completed"
          ls -la sapi/cli/php sapi/fpm/php-fpm

      - name: Verify no Homebrew dylib leaks (macOS)
        if: startsWith(matrix.os, 'macos')
        run: |
          echo "=== CLI binary ==="
          otool -L php-src/sapi/cli/php
          echo ""
          echo "=== FPM binary ==="
          otool -L php-src/sapi/fpm/php-fpm
          echo ""
          # Fail if any /opt/homebrew dylib is referenced
          if otool -L php-src/sapi/cli/php php-src/sapi/fpm/php-fpm | grep -q '/opt/homebrew'; then
            echo "::error::Binary links to Homebrew dylibs — not portable!"
            otool -L php-src/sapi/cli/php php-src/sapi/fpm/php-fpm | grep '/opt/homebrew'
            exit 1
          fi
          echo "All dynamic libraries are system-only — binary is portable."

      - name: Package CLI binary
        run: |
          mkdir -p staging-cli
          cp php-src/sapi/cli/php staging-cli/php
          chmod 755 staging-cli/php
          staging-cli/php -v
          cd staging-cli
          tar czf "../php-${PHP_VERSION}-cli-${{ matrix.platform }}.tar.gz" php

      - name: Package FPM binary
        run: |
          mkdir -p staging-fpm
          cp php-src/sapi/fpm/php-fpm staging-fpm/php-fpm
          chmod 755 staging-fpm/php-fpm
          staging-fpm/php-fpm -v
          cd staging-fpm
          tar czf "../php-${PHP_VERSION}-fpm-${{ matrix.platform }}.tar.gz" php-fpm

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: php-${{ matrix.platform }}
          path: |
            php-${{ env.PHP_VERSION }}-cli-${{ matrix.platform }}.tar.gz
            php-${{ env.PHP_VERSION }}-fpm-${{ matrix.platform }}.tar.gz

  # ---------------------------------------------------------------------------
  # Download Windows build from archives
  # ---------------------------------------------------------------------------
  build-windows:
    runs-on: ubuntu-latest
    steps:
      - name: Download Windows PHP 7.4
        run: |
          for vs in vc15 vs16; do
            url="https://windows.php.net/downloads/releases/archives/php-${PHP_VERSION}-nts-Win32-${vs}-x64.zip"
            echo "Trying ${url}..."
            if curl -fSL --retry 3 "${url}" -o "php-${PHP_VERSION}-windows-x86_64.zip" 2>/dev/null; then
              echo "OK"
              break
            fi
          done

          if [ ! -f "php-${PHP_VERSION}-windows-x86_64.zip" ]; then
            echo "::error::No Windows build found for PHP ${PHP_VERSION}"
            exit 1
          fi

          ls -la "php-${PHP_VERSION}-windows-x86_64.zip"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: php-windows
          path: php-${{ env.PHP_VERSION }}-windows-x86_64.zip

  # ---------------------------------------------------------------------------
  # Create release with all binaries
  # ---------------------------------------------------------------------------
  release:
    needs: [build-unix, build-windows]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: php-*
          merge-multiple: true
          path: assets/

      - name: Generate checksums
        run: |
          cd assets
          sha256sum * > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Build manifest fragment
        run: |
          REPO="${{ github.repository }}"

          python3 -c "
          import json, os, hashlib

          version = '${PHP_VERSION}'
          minor = '${PHP_MINOR}'
          tag = 'php-${PHP_MINOR}'
          repo = '${REPO}'
          assets_dir = 'assets'
          result = {}

          for fname in sorted(os.listdir(assets_dir)):
              if fname == 'SHA256SUMS.txt':
                  continue
              fpath = os.path.join(assets_dir, fname)
              size = os.path.getsize(fpath)
              sha256 = hashlib.sha256(open(fpath, 'rb').read()).hexdigest()

              name = fname.replace(f'php-{version}-', '').rsplit('.', 2)[0]
              if name.endswith('.tar'):
                  name = name[:-4]
              if name == 'windows-x86_64':
                  name = 'cli-windows-x86_64'

              url = f'https://github.com/{repo}/releases/download/{tag}/{fname}'
              result[name] = {'url': url, 'sha256': sha256, 'size': size}

          fragment = {version: {'minor': minor, 'assets': result}}

          os.makedirs('fragments', exist_ok=True)
          with open(f'fragments/{version}.json', 'w') as f:
              json.dump(fragment, f, indent=2)
          print(json.dumps(fragment, indent=2))
          "

      - name: Upload fragment for manifest workflow
        uses: actions/upload-artifact@v4
        with:
          name: fragment-${{ env.PHP_VERSION }}
          path: fragments/

      - name: Delete existing release (if any)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="php-${PHP_MINOR}"
          gh release delete "${TAG}" --repo "${{ github.repository }}" --yes 2>/dev/null || true
          git push origin ":refs/tags/${TAG}" 2>/dev/null || true

      - name: Create release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="php-${PHP_MINOR}"
          gh release create "${TAG}" \
            --repo "${{ github.repository }}" \
            --title "PHP ${PHP_VERSION}" \
            --notes "PHP ${PHP_VERSION} binaries for all platforms. Built from source (final 7.4 release)." \
            assets/*

      - name: Fetch existing manifest
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download manifest \
            --repo "${{ github.repository }}" \
            --pattern 'manifest.json' \
            --output existing-manifest.json 2>/dev/null || echo '{"versions":{}}' > existing-manifest.json

      - name: Merge into manifest
        run: |
          python3 -c "
          import json
          from datetime import datetime, timezone

          with open('existing-manifest.json') as f:
              manifest = json.load(f)

          with open('fragments/${PHP_VERSION}.json') as f:
              fragment = json.load(f)

          manifest['versions'].update(fragment)
          manifest['generated_at'] = datetime.now(timezone.utc).strftime('%Y-%m-%dT%H:%M:%SZ')

          with open('manifest.json', 'w') as f:
              json.dump(manifest, f, indent=2)

          print(json.dumps(manifest, indent=2)[:2000])
          "

      - name: Update manifest release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release delete manifest --repo "${{ github.repository }}" --yes 2>/dev/null || true
          git push origin :refs/tags/manifest 2>/dev/null || true
          gh release create manifest \
            --repo "${{ github.repository }}" \
            --title "PHP Binaries Manifest" \
            --notes "Auto-generated manifest of all available PHP binaries with SHA256 checksums." \
            manifest.json
